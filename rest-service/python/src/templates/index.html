<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="https://api.mapy.cz/loader.js"></script>
  <script>Loader.load()</script>
  <title>Větrání bez jedů</title>
  <style>
 html,
body {
  position: fixed;
  overflow: visible;
  padding:0;
  margin:0;
}
  .time-control {
      background-color:white;
      border-radius:5px;
      min-width:50px;
      min-height:50px;
  }

#wrapper {
overflow-y: hidden;
-webkit-overflow-scrolling: touch; /* enables “momentum” (smooth) scrolling */
margin-bottom:1px;
}
#mapa{
width: 100vw;
height: 100vh;
}
#logo {
    width:120px;
    top:10px;
    left:10px;
    position: absolute;
    z-index: 10;
}
#time-display {
    padding:5px;
  }
  </style>
</head>
<body>
<div id="wrapper">
<img id="logo" src="static/logo1.png">
<div id="mapa"></div></div>
    <script type="text/javascript">
    $(document).ready(function() {
$(window).resize(function() {
$('#mapa').height = window.innerHeight
})
$(window).resize();
window.scroll(0,1)
        var stred = SMap.Coords.fromWGS84(18.29, 49.83);
		var mapa = new SMap(JAK.gel("mapa"), stred, 13);
		mapa.addDefaultLayer(SMap.DEF_BASE).enable();
		mapa.addDefaultControls();	     


        var vrstva = new SMap.Layer.Canvas(0,0);     /* Obrázková vrstva */

        mapa.addLayer(vrstva);                      /* Přidat ji do mapy */
        vrstva.enable(); 
        var drawSource = function (coords,range,bearing,speed,arcAngle,color) {
            var ctx = vrstva.getContext();
            ctx.beginPath();
            if (speed<1) {
                range=500;
                arcAngle=360;
            }
            var pixel = coords.toPixel(mapa);
            var x = pixel.x+ctx.canvas.width/2
            var y = pixel.y+ctx.canvas.height/2
            var metric = new SMap.Pixel(1,0).toCoords(mapa).distance(mapa.getCenter())
            var length = range/metric;
            ctx.arc(x,y,length,2*Math.PI/360*(bearing+90-arcAngle/2),2*Math.PI/360*(bearing+90+arcAngle/2));
            ctx.lineTo(x,y) 
            
            var grad = ctx.createRadialGradient(x, y, 0, x, y, length)
            grad.addColorStop(0,color)
            grad.addColorStop(1,"rgba(255,0,0,0)")
            ctx.fillStyle=grad;
            ctx.fill();
        }
$(window).resize(function () {
$('#mapa').height(window.innerHeight);
});
$(window).resize();
window.scroll(0,1);
        var ctrl = new SMap.Control.Visible();
        ctrl.getContainer = function() {
            return $('<div class="time-control"><input id="time-selector" type="range" min="0" max="78" value="0"><div id="time-display"></div></div>')[0];
        }
        mapa.addControl(ctrl,{right:"18px",bottom:"30px"});
        var selectorSlider = $('#time-selector');
        var timeDisplay = $('#time-display');
        selectorSlider.on('input',function(event) {
            getForecastData(parseInt(selectorSlider.val()));
        })
        var winddir;
        var windspeed;
        var forecastRefDate;
        var getForecastData = function (forecastHour) {
            jQuery.getJSON("data?lat=49.8313933&lon=18.2738400").then(function (data) {
                if (forecastHour==null) {
                forecastRefDate=new Date(data.refdate)
                var dateDif = new Date()-forecastRefDate;
                var currentForecastHour = Math.floor(dateDif/60000/60);
                winddir=data.direction[currentForecastHour]
                windspeed=data.speed[currentForecastHour]
                selectorSlider.val(currentForecastHour);
                forecastHour=currentForecastHour;
                }
                winddir=data.direction[forecastHour]
                windspeed=data.speed[forecastHour]
                var forecastDate=new Date(forecastRefDate);
                forecastDate.setHours(forecastRefDate.getHours()+forecastHour)
                timeDisplay.text(forecastDate.getDate()+". "+(forecastDate.getMonth()+1)+". "+forecastDate.getHours()+ ":00");
                vrstva.redraw()
        })
        }
        getForecastData();
        vrstva.redraw=function(full){
            var ctx = vrstva.getContext()
            vrstva.removeAll()
            var source = SMap.Coords.fromWGS84(18.277, 49.858);
            //49.7953294N, 18.3249392E
            var source2 = SMap.Coords.fromWGS84(18.325, 49.795);
            var source3 = SMap.Coords.fromWGS84(18.2905, 49.715);
            var source4 = SMap.Coords.fromWGS84(18.329, 49.788);
            //49.7880272N, 18.3290719E
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            if(ctx.canvas.offsetParent!=null) {
                ctx.canvas.style.left=(-parseInt(ctx.canvas.offsetParent.style.left))+"px"
                ctx.canvas.style.top=(-parseInt(ctx.canvas.offsetParent.style.top))+"px"
            }
            //49.8583478N, 18.2769303E
            //49.7153828N, 18.2905747E
            drawSource(source,3800,winddir,windspeed,15,"red");
            drawSource(source2,3800,winddir,windspeed,15,"red");
            drawSource(source4,3800,winddir,windspeed,15,"red");
            //drawSource(source3,10000,189,15,"orange");
        }
        vrstva.redraw(true)
    })
		 	      
	</script>
</body>
</html>
